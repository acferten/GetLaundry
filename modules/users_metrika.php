<?php

echo "gf";


# –ö—É—Ä—å–µ—Ä –≤–µ—Ä–Ω—É–ª –∑–∞–∫–∞–∑
if ($atext[0] == '/orders_back_kurer') {
    $wapp_prefix = "WA";

    if (substr($atext[1], 0, strlen($wapp_prefix)) == $wapp_prefix) {
        $curl = curl_init();

        curl_setopt_array($curl, array(
            CURLOPT_URL => 'https://whatsapp.laundrybot.online/bot/webhook.php',
            CURLOPT_RETURNTRANSFER => true,
            CURLOPT_ENCODING => '',
            CURLOPT_MAXREDIRS => 10,
            CURLOPT_TIMEOUT => 0,
            CURLOPT_FOLLOWLOCATION => true,
            CURLOPT_HTTP_VERSION => CURL_HTTP_VERSION_1_1,
            CURLOPT_CUSTOMREQUEST => 'POST',
            CURLOPT_POSTFIELDS => json_encode([
                "data" => [
                    "type" => "delivered",
                    "order_id" => substr_replace($atext[1], "", 0, 2),
                    "message_id" => $message_id,
                ]
            ]),
            CURLOPT_HTTPHEADER => array(
                'Content-Type: application/json'
            ),
        ));

        $response = curl_exec($curl);

        curl_close($curl);

        return;
    }

    $this->DelMessageText($chat_id, $message_id);


    # –ò–Ω—Ñ–æ—Ä–º–∞—Ü–∏—è –æ –∑–∞—è–≤–∫–µ
    $orders = R::findOne('orders', "id = $atext[1]");
    $user = R::findOne('users', "chat_id = {$orders["chat_id"]}");
    
    if ($user['lang'] == 'ru'){
        $buttons[] = [
            $this->buildInlineKeyBoardButton("5 ‚ùÑÔ∏è - —Å—É–ø–µ—Ä", "/otziv $atext[1] 5"),
        ];
        $buttons[] = [
            $this->buildInlineKeyBoardButton("4 ‚ùÑÔ∏è - —Ö–æ—Ä–æ—à–æ", "/otziv $atext[1] 4"),
        ];
        $buttons[] = [
            $this->buildInlineKeyBoardButton("3 ‚ùÑÔ∏è - –Ω–æ—Ä–º–∞–ª—å–Ω–æ", "/otziv $atext[1] 3"),
        ];
        $buttons[] = [
            $this->buildInlineKeyBoardButton("2 ‚ùÑÔ∏è - –ø–ª–æ—Ö–æ", "/otziv $atext[1] 2"),
        ];
        $buttons[] = [
            $this->buildInlineKeyBoardButton("1 ‚ùÑÔ∏è - —É–∂–∞—Å–Ω–æ", "/otziv $atext[1] 1"),
        ];
    } else {
        $buttons[] = [
             $this->buildInlineKeyBoardButton("5 ‚ùÑÔ∏è - super", "/otziv $atext[1] 5"),
         ];
         $buttons[] = [
             $this->buildInlineKeyBoardButton("4 ‚ùÑÔ∏è - good", "/otziv $atext[1] 4"),
         ];
         $buttons[] = [
             $this->buildInlineKeyBoardButton("3 ‚ùÑÔ∏è - OK", "/otziv $atext[1] 3"),
         ];
         $buttons[] = [
             $this->buildInlineKeyBoardButton("2 ‚ùÑÔ∏è - bad", "/otziv $atext[1] 2"),
         ];
         $buttons[] = [
             $this->buildInlineKeyBoardButton("1 ‚ùÑÔ∏è - terrible", "/otziv $atext[1] 1"),
         ];
    }

    $template = new Template("order/courier_delivered", $user['lang'], [
        new TemplateData(":chatId", $orders['chat_id']),
    ]);
    $template = $template->Load();

    $this->sendMessage($orders['chat_id'], $template->text, $buttons);

    # –ö–æ–≥–¥–∞ –∫—É—Ä—å–µ—Ä –≤–µ—Ä–Ω—É–ª –∑–∞–∫–∞–∑
    $set_orders = R::findOne('orders', "id = $atext[1]");
    $set_orders->time_end = time();
    $set_orders->timestamp_end = time();
    $set_orders->status = "4";
    
    R::store($set_orders);

    $this->DelMessageText($set_orders['temp_chat_id'], $set_orders['mess_id']);
    $this->sendOrdersAdmin($set_orders['temp_chat_id'], $atext[1], $user['username'], False);

    return;
}

#
if ($atext[0] == '/orders_orders_card_kurer') {
    $wapp_prefix = "WA";

    if (substr($atext[1], 0, strlen($wapp_prefix)) == $wapp_prefix) {
        $curl = curl_init();

        curl_setopt_array($curl, array(
            CURLOPT_URL => 'https://whatsapp.laundrybot.online/bot/webhook.php',
            CURLOPT_RETURNTRANSFER => true,
            CURLOPT_ENCODING => '',
            CURLOPT_MAXREDIRS => 10,
            CURLOPT_TIMEOUT => 0,
            CURLOPT_FOLLOWLOCATION => true,
            CURLOPT_HTTP_VERSION => CURL_HTTP_VERSION_1_1,
            CURLOPT_CUSTOMREQUEST => 'POST',
            CURLOPT_POSTFIELDS => json_encode([
                "data" => [
                    "type" => "payed",
                    "order_id" => substr_replace($atext[1], "", 0, 2),
                    "message_id" => $message_id,
                    "pay_type" => $atext[2],
                ]
            ]),
            CURLOPT_HTTPHEADER => array(
                'Content-Type: application/json'
            ),
        ));

        $response = curl_exec($curl);

        curl_close($curl);

        return;
    }

    $this->DelMessageText($chat_id, $message_id);

    # –ö–æ–≥–¥–∞ –∫—É—Ä—å–µ—Ä –≤–µ—Ä–Ω—É–ª –∑–∞–∫–∞–∑
    $set_orders = R::findOne('orders', "id = $atext[1]");
    $set_orders->paid = $atext[2];
    $set_orders->status = "6";
    R::store($set_orders);

    $this->sendOrdersAdmin($chat_id, $atext[1], $message_id);

    if ($atext[2] == 1) {
        $content_admin = "<b>üíµOrder #$atext[1] paid to the courier.</b> \n–ûrder completed üëç";
    } else if ($atext[2] == 2) {
        $content_admin = "<b>üí≥Order #$atext[1] paid by PermataBank.</b> \n–ûrder completed üëç";
    } else if ($atext[2] == 3) {
        $content_admin = "<b>üí≥Order #$atext[1] paid by Tinkoff.</b> \n–ûrder completed üëç";
    }

    # $this->sendMessage(ID_CHAT, $content_admin);


    # $this->sendMessage(ID_CHAT, "<b>üëç Order:</b> #$atext[1] completed");

    return;
}
# –û—Ç–∑—ã–≤ –æ –∑–∞–∫–∞–∑–µ
if ($atext[0] == '/otziv') {

    # –ö–æ–ª-–≤–æ –Ω–∞–∂–∞—Ç–∏–π –º–µ—Ç—Ä–∏–∫–∞
    $this->set_metrika($chat_id, 6);

    # –£—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ–º –æ—Ç–∑—ã–≤ –∑–∞–∫–∞–∑—É
    # $this->get_orders($atext[1], "otziv", $atext[2])

    $orders = R::findOne('orders', "id = $atext[1]");
    $orders->otziv = $atext[2];
    $user = R::findOne("users", "chat_id = {$orders["chat_id"]}");
    R::store($orders);

    if ($atext[2] == '5') {
        if ($user['lang'] == 'ru'){
            $content1 = "ü§© –°–ø–∞—Å–∏–±–æ –∑–∞ –≤—ã—Å–æ–∫—É—é –æ—Ü–µ–Ω–∫—É –Ω–∞—à–µ–π —Ä–∞–±–æ—Ç—ã!

üí∞<b>–ü–æ–ª—É—á–∏—Ç–µ 2 –∫–≥ –∏–ª–∏ 1.600 —Ä—É–±–ª–µ–π</b> –Ω–∞ —Å–ª–µ–¥—É—é—â—É—é —Å—Ç–∏—Ä–∫—É. 
ü§≥–í—ã–ª–æ–∂–∏—Ç–µ –≤ Telegram Stories —á–µ—Å—Ç–Ω—ã–π –æ—Ç–∑—ã–≤ –æ –Ω–∞—Å.
üë©üèª‚Äçüíª–û—Ç–ø—Ä–∞–≤—å—Ç–µ –º–µ–Ω–µ–¥–∂–µ—Ä—É —Å–∫—Ä–∏–Ω—à–æ—Ç.

";
            $buttons[] = [
                $this->buildInlineKeyBoardButton("–ù–∞–ø–∏—Å–∞—Ç—å –º–µ–Ω–µ–¥–∂–µ—Ä—É", " ", "https://t.me/LaundryBot_Russia"),
                # $this->buildInlineKeyBoardButton("–ù–∞–ø–∏—Å–∞—Ç—å –∫–æ–º–º–µ–Ω—Ç–∞—Ä–∏–π", "/otziv_comments $atext[1] $atext[2]"),
            ];
            
            $buttons[] = [
                $this->buildInlineKeyBoardButton("–†–µ–∫–æ–º–µ–Ω–¥–æ–≤–∞—Ç—å –¥—Ä—É–≥—É", " ", "https://t.me/share/url?url=https://t.me/LaundryGo_bot?start=ref$chat_id"),
            ];
    
            $buttons[] = [
                $this->buildInlineKeyBoardButton("–ó–∞–∫–∞–∑–∞—Ç—å —Å—Ç–∏—Ä–∫—É", "/start 1"),
            ];
        } else {
            $content1 = "Thank you for appreciating and trusting LaundryBot.";
            
            $buttons[] = [
                $this->buildInlineKeyBoardButton("Recommend to a Friend", " ", "https://t.me/share/url?url=https://t.me/LaundryGo_bot?start=ref$chat_id"),
            ];
    
            $buttons[] = [
                $this->buildInlineKeyBoardButton("Order Laundry", "/start 1"),
            ];
        }

        

        $this->editMessageText($chat_id, $message_id, $content1, $buttons);
        
        $this->sendOrdersAdmin($orders['temp_chat_id'], $atext[1], $username, False);
        # $this->sendMessage(ID_CHAT, "<b>‚ÑπÔ∏è –ó–∞–∫–∞–∑ #$atext[1] </b>\n–û—Ü–µ–Ω–∫–∞ –∫–ª–∏–µ–Ω—Ç–∞ $atext[2]‚ùÑÔ∏è");
    } else {

        
        
        if ($user['lang'] == 'ru'){
            $content1 = "üò± –≠—Ç–æ —É–∂–∞—Å–Ω–æ –∏ –Ω–µ –ø–æ–∑–≤–æ–ª–∏—Ç–µ–ª—å–Ω–æ —Å –Ω–∞—à–µ–π —Å—Ç–æ—Ä–æ–Ω—ã.
–ü–æ–¥—Å–∫–∞–∂–∏—Ç–µ, –ø–æ–∂–∞–ª—É–π—Å—Ç–∞, —á—Ç–æ –∫–æ–Ω–∫—Ä–µ—Ç–Ω–æ –≤–∞—Å –Ω–µ —É—Å—Ç—Ä–æ–∏–ª–æ –≤ –∫–∞—á–µ—Å—Ç–≤–µ —Å—Ç–∏—Ä–∫–∏ –∏–ª–∏ –≤ —Ä–∞–±–æ—Ç–µ —Å–µ—Ä–≤–∏—Å–∞. 
üö® –°—Ä–æ—á–Ω–æ —Å–æ–æ–±—â–∏—Ç–µ –æ–± —ç—Ç–æ–º –º–µ–Ω–µ–¥–∂–µ—Ä—É.  
            
üòá<b>–ö–∞–∫ –º—ã –º–æ–∂–µ–º –∏—Å–ø—Ä–∞–≤–∏—Ç—å —Å–∏—Ç—É–∞—Ü–∏—é?</b>";
            
            $buttons[] = [
                $this->buildInlineKeyBoardButton("–ù–∞–ø–∏—Å–∞—Ç—å –º–µ–Ω–µ–¥–∂–µ—Ä—É", " ", "https://t.me/LaundryBot_Russia"),
                # $this->buildInlineKeyBoardButton("–ù–∞–ø–∏—Å–∞—Ç—å –∫–æ–º–º–µ–Ω—Ç–∞—Ä–∏–π", "/otziv_comments $atext[1] $atext[2]"),
            ];
    
            $buttons[] = [
                $this->buildInlineKeyBoardButton("–ó–∞–∫–∞–∑–∞—Ç—å —Å—Ç–∏—Ä–∫—É", "/start 1"),
            ];
        } else {
            $content1 = "Please tell me what did not suit you in the laundry and in the work of the service. How can we fix the situation?";
            
            $buttons[] = [
                 $this->buildInlineKeyBoardButton("Write a comment", " ", "https://t.me/LaundryGoBot"),
                 # $this->buildInlineKeyBoardButton("Write a comment", "/otziv_comments $atext[1] $atext[2]"),
             ];
    
            $buttons[] = [
                $this->buildInlineKeyBoardButton("Order Laundry", "/start 1"),
            ];
        }

        $this->editMessageText($chat_id, $message_id, $content1, $buttons);
        
        $this->sendOrdersAdmin($orders['temp_chat_id'], $atext[1], $username, False);
        # $this->sendMessage(ID_CHAT, "<b>‚ÑπÔ∏è –ó–∞–∫–∞–∑ #$atext[1] </b>\n–û—Ü–µ–Ω–∫–∞ –∫–ª–∏–µ–Ω—Ç–∞ $atext[2]‚ùÑÔ∏è");
    }

    $this->DelMessageText($orders['temp_chat_id'], $orders['mess_id']);
   

    return;
}


#
if ($atext[0] == '/orders_oplata_kurer') {

    $this->DelMessageText($chat_id, $message_id);

    # –ö–æ–≥–¥–∞ –∫—É—Ä—å–µ—Ä –≤–µ—Ä–Ω—É–ª –∑–∞–∫–∞–∑
    $set_orders = R::findOne('orders', "id = $atext[1]");
    $set_orders->status = "4";
    R::store($set_orders);

    $this->sendOrdersAdmin($chat_id, $atext[1], "edit", $message_id);

    if ($atext[2] == 1) {
        $content_admin = "<b>üëç Order:</b> #$atext[1] paid to the courier. \n –ûrder completed üëç";
    } else if ($atext[2] == 2) {
        $content_admin = "<b>üëç Order:</b> #$atext[1] paid by card. \n –ûrder completed üëç";
    } else if ($atext[2] == 3) {
        $content_admin = "<b>üí≥ Order #$atext[1] paid by Tinkoff.</b> \n–ûrder completed üëç";
    }

    $this->sendMessage(ID_CHAT, $content_admin);

    return;
}

/*
# –ö–Ω–æ–ø–∫–∞ –Ω–∞–ø–∏—Å–∞—Ç—å –∫–æ–º–º–µ–Ω—Ç–∞—Ä–∏–π, –û—Ç–∑—ã–≤ –æ –∑–∞–∫–∞–∑–µ
if($atext[0] == '/otziv_comments'){

    $this->DelMessageText($chat_id, $message_id);

    # –ó–∞–ø–∏—Å—ã–≤–∞–µ–º –∫–æ–º–∞–Ω–¥—É
    $this->set_action($chat_id, "comments&$atext[1]&$atext[2]");

    $content = "–ù–∞–ø–∏—à–∏—Ç–µ –∫–æ–º–º–µ–Ω—Ç–∞—Ä–∏–π";

    #$buttons[] = [
    #	$this->buildInlineKeyBoardButton("–†–µ–∫–æ–º–µ–Ω–¥–æ–≤–∞—Ç—å –¥—Ä—É–≥—É", "/cancel"),
    #];

    $this->sendMessage($chat_id, $content, $buttons);

    return;
}


if($atext[0] && $get_action[0] == "comments"){

    # –£—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ–º –æ—Ç–∑—ã–≤ –∑–∞–∫–∞–∑—É
    #$this->get_orders($get_action[1], "comments", $text)

    $orders = R::findOne('orders', "id = $get_action[1]");
    $orders->comments = $text;
    R::store($orders);

    $content = "–ë–ª–∞–≥–æ–¥–∞—Ä–∏–º –∑–∞ –æ—Ü–µ–Ω–∫—É –∏ –¥–æ–≤–µ—Ä–∏–µ –∫ —Å–µ—Ä–≤–∏—Å—É LaundryBot.";

    $buttons[] = [
        $this->buildInlineKeyBoardButton("–†–µ–∫–æ–º–µ–Ω–¥–æ–≤–∞—Ç—å –¥—Ä—É–≥—É", " ", "https://t.me/share/url?url=https://t.me/LaundryGo_bot?start=ref$chat_id"),
    ];

    $buttons[] = [
        $this->buildInlineKeyBoardButton("–ó–∞–∫–∞–∑–∞—Ç—å —Å—Ç–∏—Ä–∫—É", "/start 1"),
    ];

    $this->sendMessage($chat_id, $content, $buttons);

    $this->sendMessage(ID_CHAT, "<b>‚ÑπÔ∏è –ó–∞–∫–∞–∑ #$get_action[1] </b> \n–û—Ü–µ–Ω–∫–∞ –∫–ª–∏–µ–Ω—Ç–∞ $get_action[2]‚ùÑÔ∏è \n\n–ö–æ–º–º–µ–Ω—Ç–∞—Ä–∏–π: $text");

    $this->del_action($chat_id);

    return;
}


*/


?>